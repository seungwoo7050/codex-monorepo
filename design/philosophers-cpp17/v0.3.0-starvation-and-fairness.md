# philosophers-cpp17 v0.3.0 – 기아/공정성 지표 설계서

## 1. 목표
- 교착 회피 이후 단계로 각 전략의 공정성과 기아 가능성을 수치화한다.
- 철학자별 식사 횟수 분포와 최대 대기 시간을 기록해 단순 비교 지표를 제공한다.
- 시드/지터 옵션을 추가해 동일한 조건을 반복 실행하며 전략 효과를 재현할 수 있게 한다.

## 2. 범위
- 통계 수집
  - 철학자별 식사 횟수는 기존대로 누적한다.
  - 포크 확보 시도마다 대기 시간을 측정해 철학자별 최장 대기 시간을 기록한다.
  - 요약 로그에서 평균·최소·최대·표준편차로 식사 분포를 출력한다.
- CLI 확장
  - `--jitter-ms <ms>`: 생각/식사 시간에 추가할 랜덤 지터 상한(기본 0, 미사용).
  - `--random-seed <seed>`: 지터 생성기 시드(기본: 실행 시각 기반). 지터가 0이면 영향 없음.
- 출력 포맷
  - `[요약] 전략=... | 철학자별 식사/대기 기록` 아래에 각 철학자의 `식사 횟수`, `최대 대기`를 표기.
  - `[요약] 식사 분포: ...`와 `[요약] 대기 지표: ...` 라인으로 전체 통계를 제공.

## 3. 외부 동작 / CLI
- 실행 예시
  - `./philosophers --strategy ordered --duration-ms 1200 --jitter-ms 10 --random-seed 42`
- 주요 옵션(기본값)
  - `--strategy <naive|ordered|waiter>`: 전략 선택 (naive)
  - `--philosophers <N>`: 철학자 수 (5)
  - `--think-ms <ms>` / `--eat-ms <ms>`: 생각/식사 시간 (200/300)
  - `--lock-timeout-ms <ms>`: 포크 대기 시간 (800)
  - `--stuck-threshold-ms <ms>`: 교착 징후 감지 임계값 (700)
  - `--duration-ms <ms>`: 전체 실행 시간 (3000)
  - `--jitter-ms <ms>`: 지터 상한 (0)
  - `--random-seed <seed>`: 지터 시드 (실행 시각 기반)
- 출력
  - 상태 로그와 함께 교착 안내(naive), 철학자별 식사/대기 기록, 식사 분포/대기 지표 요약을 출력한다.

## 4. 내부 설계
- `SimulationConfig`
  - `jitter_range: milliseconds`, `random_seed: unsigned int` 필드를 추가한다.
- `DiningSimulation`
  - 통계
    - `meals_`: 식사 횟수 누적(기존 유지).
    - `max_wait_ms_`: 포크 확보 시도마다 측정한 대기 시간을 `compare_exchange`로 최장값 갱신.
    - `logSummary`에서 합계/분산을 계산해 평균·표준편차, 최장 대기 시간을 함께 출력한다.
  - 대기 측정
    - 철학자가 포크를 시도하기 직전 타임스탬프를 찍고, 성공/실패 여부와 무관하게 `recordWaiting`으로 누적한다.
  - 지터
    - `std::mt19937 rng_` + `std::uniform_int_distribution`으로 0~`jitter_range`를 생성한다.
    - `applyJitter`가 생각/식사 시간에 지터를 더하며, `jitter_range`가 0이면 그대로 반환한다.
- 동기화 및 종료 흐름은 v0.2.0과 동일하게 유지하며, 모니터 스레드가 `stop_requested_` 설정 시 웨이터 대기 스레드를 깨운다.

## 5. 테스트 전략
- `tests/deadlock_demo.sh`: naive 설정에서 교착 감지 로그와 요약 출력 확인.
- `tests/ordered_strategy.sh`: ordered 전략에서 교착 메시지 부재 및 식사 기록 5줄 이상 확인.
- `tests/waiter_strategy.sh`: waiter 전략에서 교착 메시지 부재 및 식사 기록 5줄 이상 확인.
- `tests/fairness_metrics.sh`: ordered 전략 + 지터/시드를 사용해 식사/대기 기록과 분포·대기 요약 라인 존재 여부를 검증.
- CTest에 네 스크립트를 등록해 동일한 빌드/CI 흐름으로 검증한다.

## 6. 한계 및 추후 작업
- 현재 분포 지표는 단순 평균/표준편차만 제공하므로, 퍼센타일/균형 점수 등 추가 지표를 v0.4.0 이상에서 검토할 수 있다.
- 대기 측정은 포크 확보 완료/실패 기준으로만 누적하며, 더 세밀한 이벤트(포크별 대기, 웨이터 큐 길이)는 기록하지 않는다.
- 출력은 텍스트 로그 중심이며, 필요 시 CSV/JSON 내보내기와 시각화 도구를 연동해 해석을 돕도록 확장할 수 있다.
