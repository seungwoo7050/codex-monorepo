# philosophers-cpp17 v0.1.0 – 단순 교착 상태 데모 설계서

## 1. 목표
- 좌측→우측 순서로 포크를 집는 가장 단순한 전략을 사용하여 교착 상태가 얼마나 쉽게 발생하는지 시연한다.
- CLI 기본값만으로도 잠재적 교착 상태 안내 로그가 출력되도록 한다.
- 스레드/뮤텍스 사용법과 대기 시간 조정값을 통해 데모가 일관되게 재현되도록 한다.

## 2. 범위
- N명의 철학자와 N개의 포크(뮤텍스)를 원형으로 배치한다.
- 각 철학자는 생각 → 좌측 포크 집기 → 우측 포크 집기 대기 → 식사 → 반복 흐름을 가진다.
- 우측 포크는 `std::timed_mutex`의 `try_lock_for`로 대기하며, 대기 시간 동안 교착 징후가 감지될 수 있다.
- 모니터 스레드는 일정 시간 동안 식사 진행이 없으면 교착 상태 안내 메시지를 남긴다.

## 3. 외부 동작 / CLI
- 실행: `./philosophers [옵션]`
- 주요 옵션 (기본값):
  - `--philosophers <N>`: 철학자 수 (5)
  - `--think-ms <ms>`: 생각 시간 (200)
  - `--eat-ms <ms>`: 식사 시간 (300)
  - `--lock-timeout-ms <ms>`: 우측 포크 대기 시간(또는 왼쪽 포크 홀딩 시간 계산에도 사용) (800)
  - `--stuck-threshold-ms <ms>`: 교착 징후 감지 임계값 (700)
  - `--duration-ms <ms>`: 전체 시뮬레이션 실행 시간 (3000)
- 출력: 각 철학자의 상태 로그와 `[안내] 잠재적 교착 상태 감지` 메시지, 종료 알림이 순차적으로 출력된다.

## 4. 내부 설계
- `SimulationConfig`: CLI로부터 전달되는 타이밍/개수 파라미터를 보관한다.
- `DiningSimulation`:
  - 멤버
    - `forks_`: `std::timed_mutex` 배열, 각 철학자의 좌측 포크로 취급.
    - `threads_`: 철학자 스레드 목록.
    - `meals_`, `last_meal_ms_`: 식사 횟수와 마지막 식사 시각을 원자적으로 기록.
    - `start_cv_`, `ready_count_`: 모든 철학자가 동시에 시작하도록 맞추는 배리어 역할.
    - `deadlock_noted_`, `last_progress_ms_`: 모니터 스레드가 교착 징후를 판단할 때 사용.
  - 동작
    - 철학자 스레드: 시작 배리어 통과 → 생각 → 좌측 포크 락 → `lock_timeout/2` 만큼 포크를 쥔 채 대기 → 우측 포크 `try_lock_for` 시도 → 실패 시 로그 후 재시도, 성공 시 식사/카운터 갱신.
    - 모니터 스레드: `stuck_threshold` 이상 식사가 진행되지 않으면 교착 안내 메시지 출력, `runtime`이 지나면 종료 플래그 설정.

## 5. 테스트 전략
- `tests/deadlock_demo.sh`:
  - 기본 실행 시간을 2.2초로 설정하여 첫 사이클 동안 교착 징후가 감지되도록 한다.
  - 표준 출력에 교착 안내 메시지와 종료 로그가 모두 포함되는지 확인한다.
- CTest로 스크립트를 등록하여 CI/로컬 환경에서 동일하게 실행한다.

## 6. 한계 및 추후 작업
- `try_lock_for`를 사용해 데모 후 안전하게 종료하지만, 실제 무한 교착을 강제로 만드는 대신 교착 징후를 노출하는 방식이다.
- v0.2.0에서 교착을 해결하는 전략(정렬된 포크 획득, 웨이터 패턴 등)을 추가하고, 통계 비교 CLI 옵션을 확장할 예정이다.
